<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Autoryzacji</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
      .info {
        color: blue;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Debug Autoryzacji - Athletics Platform</h1>

    <div class="section">
      <h2>1. Stan localStorage</h2>
      <button onclick="checkLocalStorage()">Sprawd≈∫ localStorage</button>
      <div id="localStorage-result"></div>
    </div>

    <div class="section">
      <h2>2. Test API - Logowanie</h2>
      <button onclick="testLogin()">Zaloguj jako admin</button>
      <div id="login-result"></div>
    </div>

    <div class="section">
      <h2>3. Test API - Pobieranie zawod√≥w</h2>
      <button onclick="testGetCompetitions()">Pobierz zawody</button>
      <div id="competitions-result"></div>
    </div>

    <div class="section">
      <h2>4. Test API - Tworzenie zawod√≥w</h2>
      <button onclick="testCreateCompetition()">Utw√≥rz testowe zawody</button>
      <div id="create-result"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3001";
      let authToken = null;

      function checkLocalStorage() {
        const result = document.getElementById("localStorage-result");
        try {
          const authStorage = localStorage.getItem("auth-storage");
          if (authStorage) {
            const parsed = JSON.parse(authStorage);
            result.innerHTML = `
                        <div class="success">‚úÖ Znaleziono dane autoryzacji</div>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                    `;
            if (parsed.state && parsed.state.token) {
              authToken = parsed.state.token;
            }
          } else {
            result.innerHTML =
              '<div class="error">‚ùå Brak danych autoryzacji w localStorage</div>';
          }
        } catch (error) {
          result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd parsowania: ${error.message}</div>`;
        }
      }

      async function testLogin() {
        const result = document.getElementById("login-result");
        result.innerHTML = '<div class="info">üîÑ Logowanie...</div>';

        try {
          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: "admin@athletics.pl",
              password: "password123",
            }),
          });

          if (response.ok) {
            const data = await response.json();
            authToken = data.token;
            result.innerHTML = `
                        <div class="success">‚úÖ Logowanie udane</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
          } else {
            const error = await response.text();
            result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd logowania: ${error}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd sieci: ${error.message}</div>`;
        }
      }

      async function testGetCompetitions() {
        const result = document.getElementById("competitions-result");
        result.innerHTML = '<div class="info">üîÑ Pobieranie zawod√≥w...</div>';

        if (!authToken) {
          result.innerHTML =
            '<div class="error">‚ùå Brak tokenu autoryzacji. Zaloguj siƒô najpierw.</div>';
          return;
        }

        try {
          const response = await fetch(`${API_URL}/competitions`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            result.innerHTML = `
                        <div class="success">‚úÖ Pobrano ${data.length} zawod√≥w</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
          } else {
            const error = await response.text();
            result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd pobierania: ${error}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd sieci: ${error.message}</div>`;
        }
      }

      async function testCreateCompetition() {
        const result = document.getElementById("create-result");
        result.innerHTML = '<div class="info">üîÑ Tworzenie zawod√≥w...</div>';

        if (!authToken) {
          result.innerHTML =
            '<div class="error">‚ùå Brak tokenu autoryzacji. Zaloguj siƒô najpierw.</div>';
          return;
        }

        const competitionData = {
          name: "Debug Test Zawody " + new Date().toISOString(),
          description: "Testowe zawody utworzone przez debug",
          startDate: "2025-08-01T10:00:00.000Z",
          endDate: "2025-08-01T18:00:00.000Z",
          location: "Warszawa",
          venue: "Stadion Testowy",
          type: "OUTDOOR",
          registrationStartDate: "2025-07-01T00:00:00.000Z",
          registrationEndDate: "2025-07-30T23:59:59.000Z",
          maxParticipants: 100,
          registrationFee: 25.0,
          isPublic: true,
          allowLateRegistration: false,
        };

        try {
          const response = await fetch(`${API_URL}/competitions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(competitionData),
          });

          if (response.ok) {
            const data = await response.json();
            result.innerHTML = `
                        <div class="success">‚úÖ Zawody utworzone pomy≈õlnie!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
          } else {
            const error = await response.text();
            result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd tworzenia: ${error}</div>`;
          }
        } catch (error) {
          result.innerHTML = `<div class="error">‚ùå B≈ÇƒÖd sieci: ${error.message}</div>`;
        }
      }

      // Automatycznie sprawd≈∫ localStorage przy ≈Çadowaniu
      window.onload = function () {
        checkLocalStorage();
      };
    </script>
  </body>
</html>
